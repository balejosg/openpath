#!/usr/bin/env node
/**
 * check-new-file-coverage.js - Verify new/modified files meet 80% coverage threshold
 *
 * This script checks that files modified in the current commit have at least 80%
 * line coverage. It reads coverage data from JSON reports generated by c8/vitest.
 *
 * Part of the mandatory test enforcement policy.
 */

import { execSync } from 'node:child_process';
import { existsSync, readFileSync } from 'node:fs';
import { resolve, relative } from 'node:path';

const ROOT_DIR = resolve(import.meta.dirname, '..');
const COVERAGE_THRESHOLD = 80;

// Coverage report locations by workspace
const COVERAGE_REPORTS = [
  { workspace: 'api', path: 'api/coverage/coverage-final.json' },
  { workspace: 'react-spa', path: 'react-spa/coverage/coverage-final.json' },
  { workspace: 'shared', path: 'shared/coverage/coverage-final.json' },
  { workspace: 'dashboard', path: 'dashboard/coverage/coverage-final.json' },
  {
    workspace: 'firefox-extension',
    path: 'firefox-extension/coverage/coverage-final.json',
  },
];

// Files/patterns excluded from coverage check
const EXCLUDED_PATTERNS = [
  /\.d\.ts$/,
  /index\.(ts|tsx)$/,
  /types\.(ts|tsx)$/,
  /\.types\.(ts|tsx)$/,
  /constants\.(ts|tsx)$/,
  /\.constants\.(ts|tsx)$/,
  /\.config\.(ts|js)$/,
  /config\.(ts|js)$/,
  /main\.(ts|tsx)$/,
  /App\.tsx$/,
  /setup\.ts$/,
  /logger\.ts$/,
  /swagger\.ts$/,
  /vite-env\.d\.ts$/,
  /routeTree\.gen\.ts$/,
  /\/drizzle\//,
  /\/migrations\//,
  /\/generated\//,
  /\/tests?\//,
  /\/__tests__\//,
  /\/e2e\//,
  /\.test\.(ts|tsx)$/,
  /\.spec\.(ts|tsx)$/,
];

function isExcluded(filePath) {
  return EXCLUDED_PATTERNS.some((pattern) => pattern.test(filePath));
}

function getChangedFiles() {
  try {
    // Get staged files (for pre-commit) or changed files in last commit
    let files;
    try {
      files = execSync('git diff --cached --name-only --diff-filter=ACMR', {
        encoding: 'utf-8',
        cwd: ROOT_DIR,
      });
    } catch {
      // Fallback to last commit diff
      files = execSync('git diff HEAD~1 --name-only --diff-filter=ACMR', {
        encoding: 'utf-8',
        cwd: ROOT_DIR,
      });
    }

    return files
      .split('\n')
      .filter((f) => f.trim())
      .filter((f) => /\.(ts|tsx)$/.test(f))
      .filter((f) => !isExcluded(f))
      .filter(
        (f) =>
          f.startsWith('api/src/') ||
          f.startsWith('react-spa/src/') ||
          f.startsWith('shared/src/') ||
          f.startsWith('dashboard/src/') ||
          f.startsWith('firefox-extension/src/')
      );
  } catch (error) {
    console.error('Failed to get changed files:', error.message);
    return [];
  }
}

function loadCoverageData() {
  const allCoverage = {};

  for (const { workspace, path: reportPath } of COVERAGE_REPORTS) {
    const fullPath = resolve(ROOT_DIR, reportPath);
    if (!existsSync(fullPath)) {
      console.log(`  [${workspace}] No coverage report found (run tests first)`);
      continue;
    }

    try {
      const data = JSON.parse(readFileSync(fullPath, 'utf-8'));
      // Normalize paths to be relative to ROOT_DIR
      for (const [filePath, coverage] of Object.entries(data)) {
        const relativePath = relative(ROOT_DIR, filePath);
        allCoverage[relativePath] = coverage;
      }
      console.log(`  [${workspace}] Loaded coverage data`);
    } catch (error) {
      console.error(`  [${workspace}] Failed to parse coverage: ${error.message}`);
    }
  }

  return allCoverage;
}

function calculateLineCoverage(fileCoverage) {
  if (!fileCoverage || !fileCoverage.statementMap) {
    return null;
  }

  const statements = fileCoverage.s || {};
  const statementMap = fileCoverage.statementMap || {};

  let covered = 0;
  let total = 0;

  for (const stmtId of Object.keys(statementMap)) {
    total++;
    if (statements[stmtId] > 0) {
      covered++;
    }
  }

  if (total === 0) {
    return 100; // No statements = 100% covered
  }

  return Math.round((covered / total) * 100);
}

function main() {
  console.log('');
  console.log('Checking coverage for new/modified files...');
  console.log(`Threshold: ${COVERAGE_THRESHOLD}%`);
  console.log('');

  const changedFiles = getChangedFiles();

  if (changedFiles.length === 0) {
    console.log('No source files changed (or all excluded). Skipping coverage check.');
    process.exit(0);
  }

  console.log(`Found ${changedFiles.length} changed source file(s):`);
  changedFiles.forEach((f) => console.log(`  - ${f}`));
  console.log('');

  console.log('Loading coverage reports...');
  const coverage = loadCoverageData();
  console.log('');

  if (Object.keys(coverage).length === 0) {
    console.log('WARNING: No coverage data found. Run tests with coverage first.');
    console.log('Skipping coverage check for this commit.');
    console.log('');
    // Don't fail - coverage might not be generated yet
    process.exit(0);
  }

  const failures = [];
  const successes = [];
  const missing = [];

  for (const file of changedFiles) {
    const fileCoverage = coverage[file];

    if (!fileCoverage) {
      missing.push(file);
      continue;
    }

    const lineCoverage = calculateLineCoverage(fileCoverage);

    if (lineCoverage === null) {
      missing.push(file);
      continue;
    }

    if (lineCoverage < COVERAGE_THRESHOLD) {
      failures.push({ file, coverage: lineCoverage });
    } else {
      successes.push({ file, coverage: lineCoverage });
    }
  }

  // Report results
  if (successes.length > 0) {
    console.log('\x1b[32mFiles meeting coverage threshold:\x1b[0m');
    successes.forEach(({ file, coverage: cov }) => {
      console.log(`  ${file}: ${cov}%`);
    });
    console.log('');
  }

  if (missing.length > 0) {
    console.log('\x1b[33mFiles without coverage data (need tests):\x1b[0m');
    missing.forEach((file) => {
      console.log(`  ${file}`);
    });
    console.log('');
  }

  if (failures.length > 0) {
    console.log('\x1b[31mFiles BELOW coverage threshold:\x1b[0m');
    failures.forEach(({ file, coverage: cov }) => {
      console.log(`  ${file}: ${cov}% (required: ${COVERAGE_THRESHOLD}%)`);
    });
    console.log('');
    console.log('\x1b[31mERROR: Some files do not meet the coverage threshold.\x1b[0m');
    console.log('');
    console.log('To fix:');
    console.log('  1. Add more tests for the failing files');
    console.log('  2. Run "npm run test:coverage" to regenerate coverage');
    console.log('  3. Run this check again');
    console.log('');
    process.exit(1);
  }

  // Treat missing coverage as warning, not failure (tests might not exist yet)
  if (missing.length > 0) {
    console.log('\x1b[33mWARNING: Some files have no coverage data.\x1b[0m');
    console.log('Make sure to add tests for these files.');
    console.log('');
  }

  console.log('\x1b[32mAll checked files meet the coverage threshold.\x1b[0m');
  process.exit(0);
}

main();
