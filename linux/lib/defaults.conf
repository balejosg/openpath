#!/bin/bash

# OpenPath - Strict Internet Access Control
# Copyright (C) 2025 OpenPath Authors
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

################################################################################
# defaults.conf - Configurable default values
# Part of the OpenPath DNS system
#
# Override these values via:
# - Environment variables (e.g., OPENPATH_FALLBACK_DNS=1.1.1.1)
# - Custom config file at /etc/openpath/overrides.conf
################################################################################

# Load custom overrides if present (user configuration)
if [ -f /etc/openpath/overrides.conf ]; then
    # shellcheck source=/dev/null
    source /etc/openpath/overrides.conf
fi

# =============================================================================
# DNS Configuration
# =============================================================================

# Primary fallback DNS server (used when upstream detection fails)
# Override: OPENPATH_FALLBACK_DNS environment variable
FALLBACK_DNS_PRIMARY="${OPENPATH_FALLBACK_DNS:-8.8.8.8}"

# Secondary fallback DNS server
# Override: OPENPATH_FALLBACK_DNS_SECONDARY environment variable
FALLBACK_DNS_SECONDARY="${OPENPATH_FALLBACK_DNS_SECONDARY:-8.8.4.4}"

# Comma-separated DoH resolver IPs to block on TCP/UDP 443
# Override: OPENPATH_DOH_RESOLVERS environment variable
DOH_RESOLVERS="${OPENPATH_DOH_RESOLVERS:-8.8.8.8,8.8.4.4,1.1.1.1,1.0.0.1,9.9.9.9,149.112.112.112,208.67.222.222,208.67.220.220,45.90.28.0,45.90.30.0,194.242.2.2,194.242.2.3,94.140.14.14,94.140.15.15,76.76.2.0,76.76.10.0}"

# Comma-separated VPN block rules in protocol:port:name format
# Example: udp:1194:OpenVPN,tcp:1194:OpenVPN-TCP,udp:51820:WireGuard
# Override: OPENPATH_VPN_BLOCK_RULES environment variable
VPN_BLOCK_RULES="${OPENPATH_VPN_BLOCK_RULES:-udp:1194:OpenVPN,tcp:1194:OpenVPN-TCP,udp:51820:WireGuard,tcp:1723:PPTP,udp:500:IKE,udp:4500:IPSec-NAT}"

# Comma-separated Tor ports to block
# Override: OPENPATH_TOR_BLOCK_PORTS environment variable
TOR_BLOCK_PORTS="${OPENPATH_TOR_BLOCK_PORTS:-9001,9030,9050,9051,9150}"

# =============================================================================
# Captive Portal Detection
# =============================================================================

# URL for captive portal detection
# Override: OPENPATH_CAPTIVE_PORTAL_URL environment variable
CAPTIVE_PORTAL_URL="${OPENPATH_CAPTIVE_PORTAL_URL:-http://detectportal.firefox.com/success.txt}"

# Expected response from captive portal check
CAPTIVE_PORTAL_EXPECTED="${OPENPATH_CAPTIVE_PORTAL_EXPECTED:-success}"

# =============================================================================
# Whitelist Configuration
# =============================================================================

# Default whitelist URL (used during initial installation)
# Override: --whitelist-url flag during install
# Override: /etc/openpath/whitelist-url.conf after installation
DEFAULT_WHITELIST_URL="${OPENPATH_DEFAULT_WHITELIST_URL:-https://raw.githubusercontent.com/LasEncinasIT/Whitelist-por-aula/refs/heads/main/Informatica%203.txt}"

# =============================================================================
# Timeouts and Retries
# =============================================================================

# Curl timeout for whitelist download (seconds)
WHITELIST_DOWNLOAD_TIMEOUT="${OPENPATH_DOWNLOAD_TIMEOUT:-30}"

# DNS validation timeout (seconds)
DNS_VALIDATION_TIMEOUT="${OPENPATH_DNS_TIMEOUT:-5}"

# Maximum retries for port 53 freeing
PORT_53_MAX_RETRIES="${OPENPATH_PORT_53_RETRIES:-30}"

# =============================================================================
# SSE (Real-Time Updates) Configuration
# =============================================================================

# Minimum reconnect delay (seconds) after SSE connection drops
SSE_RECONNECT_MIN="${OPENPATH_SSE_RECONNECT_MIN:-5}"

# Maximum reconnect delay (seconds) with exponential backoff
SSE_RECONNECT_MAX="${OPENPATH_SSE_RECONNECT_MAX:-60}"

# Minimum seconds between consecutive update triggers (debounce)
SSE_UPDATE_COOLDOWN="${OPENPATH_SSE_UPDATE_COOLDOWN:-10}"

# =============================================================================
# Whitelist Configuration
# =============================================================================

# Maximum number of domains allowed in a whitelist (defense against oversized lists)
# Override: OPENPATH_MAX_DOMAINS environment variable
MAX_DOMAINS="${OPENPATH_MAX_DOMAINS:-500}"

# Minimum number of valid domain lines required to accept a downloaded whitelist
# Override: OPENPATH_MIN_VALID_DOMAINS environment variable
MIN_VALID_DOMAINS="${OPENPATH_MIN_VALID_DOMAINS:-5}"

# =============================================================================
# Timer Configuration
# =============================================================================

# Fallback polling interval in minutes (SSE handles real-time; this is the safety net)
# Override: OPENPATH_TIMER_INTERVAL environment variable
TIMER_INTERVAL_MINUTES="${OPENPATH_TIMER_INTERVAL:-5}"

# =============================================================================
# Offline / Expiration Policy
# =============================================================================

# Maximum age (in hours) before the cached whitelist is considered expired.
# After expiration, the agent enters fail-safe mode (blocks everything except
# essential connectivity) until a fresh whitelist can be downloaded.
# Set to 0 to disable expiration checks.
# Override: OPENPATH_WHITELIST_MAX_AGE_HOURS environment variable
WHITELIST_MAX_AGE_HOURS="${OPENPATH_WHITELIST_MAX_AGE_HOURS:-24}"
