name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

# ============================================
# IMPORTANT: Local Verification Policy
# ============================================
# All lint, typecheck, unit tests, and E2E tests MUST be run locally
# before pushing (via `npm run verify:full`).
#
# This CI only runs tests that REQUIRE specific OS environments:
# - Linux dnsmasq tests (require Ubuntu with dnsmasq/systemd)
# - Windows agent tests (require Windows with Pester)
#
# See AGENTS.md for the mandatory local verification protocol.
# ============================================

jobs:
  # ============================================
  # Job 1: Linux dnsmasq Agent Tests
  # ============================================
  test-linux-dnsmasq:
    name: Linux Agent Tests (BATS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dnsmasq
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq

      - name: Install BATS
        run: |
          sudo apt-get install -y bats

      - name: Run BATS unit tests
        run: |
          cd tests && bats *.bats

      - name: Run Linux agent E2E tests
        run: |
          bats tests/e2e/agent-integration.bats

  # ============================================
  # Job 2: Windows Agent Tests
  # ============================================
  test-windows:
    name: Windows Agent Tests (Pester)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -Scope CurrentUser
          Import-Module Pester

      - name: Run Windows Unit Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "windows/tests"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "windows-test-results.xml"
          $config.TestResult.OutputFormat = "NUnitXml"
          Invoke-Pester -Configuration $config

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-test-results
          path: windows-test-results.xml
          retention-days: 7

  # ============================================
  # Summary Job
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test-linux-dnsmasq, test-windows]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.test-linux-dnsmasq.result }}" == "failure" ]] || \
             [[ "${{ needs.test-windows.result }}" == "failure" ]]; then
            echo "CI Failed"
            exit 1
          fi
          echo "All CI checks passed"
